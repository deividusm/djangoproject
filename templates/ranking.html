<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ReciclaQuest ‚Äî Ranking</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* === PALETA DE COLORES "ELEGANT BLACK" (MODO OSCURO) === */
      --bg: #0F0F0F;
      --panel: #1B1B1B;
      --panel-2: #252525;
      --ink: #EAEAEA;
      --muted: #A0A0A0;
      --line: #303030;
      --green: #22c55e;
      --green-2: #16a34a;
      --radius: 14px;
      --shadow: 0 8px 24px rgba(0,0,0,.40), inset 0 1px 0 rgba(255,255,255,.05);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Manrope,system-ui,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}

    /* Topbar */
    .topbar{ position:sticky; top:0; z-index:30; backdrop-filter: blur(6px); background:rgba(15, 15, 15, .8); border-bottom:1px solid var(--line); }
    .topbar-inner{ display:flex; align-items:center; gap:14px; padding:12px clamp(14px,4vw,28px); max-width:1200px; margin:0 auto;}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;display:grid;place-items:center;border-radius:12px;border:1px solid var(--line);background:var(--panel);font-family:Orbitron}
    .brand b{letter-spacing:.02em;font-size:18px}
    .nav{margin-left:auto;display:flex;flex-wrap:wrap;gap:8px}
    .nav a{ text-decoration:none;color:var(--ink);padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:var(--panel) }
    .nav a.active{ background:var(--green); color:#fff; border-color:#13803d }
    .nav a:hover{ background:var(--panel-2) }

    .wrap{max-width:1200px;margin:0 auto;padding:20px clamp(16px,4vw,32px) 60px}
    
    /* === MEJORA JS/CSS: Shimmer en Tarjetas === */
    .card{ 
      position: relative; 
      overflow: hidden; 
      padding:16px; border-radius:16px; border:1px solid var(--line); background:var(--panel); box-shadow:var(--shadow); 
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0; 
      left: var(--mx, 50%);
      width: 300px;
      height: 100%;
      background: radial-gradient(circle at center, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0) 60%);
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    .card:hover::before {
      opacity: 1;
    }
    /* === FIN MEJORA === */

    h1,h2{font-family:Orbitron,Manrope;letter-spacing:.02em}
    h1{font-size:clamp(22px,3.5vw,34px);margin:0 0 8px}
    .muted{color:var(--muted)}

    .btn{ cursor:pointer; border-radius:12px; padding:10px 14px; border:1px solid #dbe9df; background:linear-gradient(180deg, var(--green), var(--green-2)); color:#07110a; font-weight:800; letter-spacing:.02em; box-shadow: 0 8px 18px rgba(34,197,94,.20), inset 0 1px 0 rgba(255,255,255,.2); }
    .btn.ghost{ background:transparent; color:var(--ink); border:1px solid var(--line); box-shadow:none; }
    .btn.ghost:hover{ background: var(--panel-2); }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .controls{ display:grid; grid-template-columns: 1.2fr .8fr .6fr .6fr; gap:10px; margin:12px 0 16px }
    .input, select{ background:var(--panel); border:1px solid var(--line); color:var(--ink); border-radius:12px; padding:10px 12px; width:100% }

    .grid{display:grid;grid-template-columns: 1.3fr .7fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .controls{grid-template-columns:1fr 1fr 1fr 1fr} }
    @media (max-width: 620px){ .controls{grid-template-columns:1fr 1fr} }

    table{ width:100%; border-collapse:collapse; background:var(--panel); border-radius: var(--radius); overflow: hidden; }
    th, td{ padding:10px; border-bottom:1px solid var(--line); text-align:left }
    th{ color:var(--ink); font-weight:600 }
    tr:last-child td { border-bottom: none; }
    tr:hover td{ background:var(--panel-2) }
    .me{ background:linear-gradient(180deg, #111e16, #1B1B1B) } /* Gradiente sutil verde oscuro */
    .badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:var(--panel-2)}

    .pagi{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:10px }
    .counter{ color:var(--muted); font-size:14px }

    .side{ display:grid; gap:10px }
    .stat{ display:flex; justify-content:space-between; gap:8px; align-items:center; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:var(--panel-2); box-shadow:var(--shadow) }
    .stat b{ font-size:18px }

    .help{font-size:13px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">‚ôªÔ∏è</div>
        <div>
          <b>ReciclaQuest</b><br>
          <small style="color:var(--muted)">Juega ¬∑ Registra ¬∑ Sube de ranking</small>
        </div>
      </div>
      <nav class="nav" aria-label="Navegaci√≥n principal">
        <a href="/hub/" >Inicio</a>
        <a href="/mapapuntos/" >Puntos de reciclaje</a>
        <a href="/verificar_mobilenet/" style="background:var(--green); color:white;">JUGAR!</a>
      </nav>
    </div>
  </div>

  <main class="wrap" id="ranking">
    <h1>Ranking general</h1>
    <p class="muted">Busca jugadores, ordena por puntos o nombre, y navega por p√°ginas. Tu usuario aparece resaltado si est√° registrado.</p>

    <div class="grid">
      <section class="card">
        <div class="controls" role="region" aria-label="Controles de ranking">
          <input id="q" class="input" type="search" placeholder="üîé Buscar jugador por nombre..." aria-label="Buscar jugador">
          <select id="sort" aria-label="Ordenar por">
            <option value="points_desc">Orden: Puntos (‚Üì)</option>
            <option value="points_asc">Orden: Puntos (‚Üë)</option>
            <option value="name_asc">Orden: Nombre (A‚ÜíZ)</option>
            <option value="name_desc">Orden: Nombre (Z‚ÜíA)</option>
          </select>
          <select id="pageSize" aria-label="Tama√±o de p√°gina">
            <option value="10">10 por p√°gina</option>
            <option value="20" selected>20 por p√°gina</option>
            <option value="50">50 por p√°gina</option>
          </select>
          <button id="reset" class="btn ghost" title="Borrar b√∫squeda y filtros">Limpiar</button>
        </div>

        <table aria-describedby="tableHelp">
          <thead>
            <tr>
              <th style="width:70px">#</th>
              <th>Jugador</th>
              <th style="width:140px">Puntos</th>
              <th style="width:160px">Acciones</th>
              <th style="width:180px">√öltima acci√≥n</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="tableHelp" class="help">El ranking mezcla jugadores demo con tus datos locales guardados desde el Hub.</div>

        <div class="pagi">
          <div style="display:flex;gap:8px">
            <button id="prev" class="btn ghost">¬´ Anterior</button>
            <button id="next" class="btn ghost">Siguiente ¬ª</button>
          </div>
          <div class="counter" id="counter">‚Äî</div>
        </div>
      </section>

      <aside class="side">
        <section class="card">
          <h2 style="margin-top:0">Tu perfil</h2>
          <div class="stat"><span>Nombre</span><b id="meName">‚Äî</b></div>
          <div class="stat"><span>Puntos</span><b id="mePoints">0</b></div>
          <div class="stat"><span>Acciones</span><b id="meActs">0</b></div>
          <div class="stat"><span>Racha</span><b id="meStreak">0 d√≠as</b></div>
          <button id="setName" class="btn" style="width:100%;margin-top:8px">Cambiar/Definir nombre</button>
          <p class="help">Si no defines un nombre, no aparecer√°s en el ranking general.</p>
        </section>

        <section class="card">
          <h2 style="margin-top:0">Consejos r√°pidos</h2>
          <div class="stat"><span>Enjuaga envases</span><span class="badge">+consistencia</span></div>
          <div class="stat"><span>Comprime botellas/cajas</span><span class="badge">+espacio</span></div>
          <div class="stat"><span>Separa vidrio sin tapas</span><span class="badge">+calidad</span></div>
        </section>
      </aside>
    </div>
  </main>

  <script>window.addEventListener('pointermove',e=>{document.documentElement.style.setProperty('--mx', (e.clientX/window.innerWidth*100)+'%')});</script>
  
  <script>
    // === Estado local compatible con HUB ===
    const KEY = 'reciclaquest-hub-v1';
    const state = JSON.parse(localStorage.getItem(KEY) || '{}');
    state.me = state.me || { name: null, points: 0 };
    state.photos = state.photos || [];
    // Jugadores demo base (si no hay en storage)
    const demoPlayers = [
      {name:'VerdeFuerte', points:220}, {name:'EcoNinja', points:190}, {name:'PlanetaKid', points:170},
      {name:'LuzVerde', points:160}, {nameT:'Matias', points:150}, {name:'Jose', points:140},
      {name:'Dani', points:120}, {name:'David', points:110}, {name:'Agus', points:100}
    ];
    state.players = state.players || demoPlayers;

    // === Utilidades ===
    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
    function uniqueDay(ts){ const d=new Date(ts); return new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime(); }
    function calcStreak(photos){
      if(!photos.length) return 0;
      const days=[...new Set(photos.map(p=>uniqueDay(p.ts)))].sort((a,b)=>b-a);
      let s=1; for(let i=1;i<days.length;i++){ const diff=(days[i-1]-days[i])/(1000*60*60*24); if(diff===1) s++; else break; }
      return s;
    }
    function lastTs(photos){ return photos.length ? Math.max(...photos.map(p=>p.ts||0)) : null; }
    function fmtDate(ts){ if(!ts) return '‚Äî'; const d=new Date(ts); return d.toLocaleDateString()+' '+d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
    function includeMe(){ return !!(state.me.name && state.me.name!=='Invitado'); }

    // === Dataset combinado ===
    function buildPlayers(){
      // base: copiar para no mutar
      const map = new Map();
      (state.players||[]).forEach(p => { if(p?.name) map.set(p.name, {name:p.name, points:+p.points||0, actions:null, last:null}); });
      // m√©tricas del usuario local
      const myActs = (state.photos||[]).length;
      const myLast = lastTs(state.photos||[]);
      if(includeMe()){
        map.set(state.me.name, {
          name: state.me.name,
          points: +state.me.points||0,
          actions: myActs||0,
          last: myLast||null,
          me: true
        });
      }
      // devuelve arreglo
      return [...map.values()];
    }

    // === Render ===
    const tbody = document.getElementById('tbody');
    const q = document.getElementById('q');
    const sortSel = document.getElementById('sort');
    const pageSizeSel = document.getElementById('pageSize');
    const resetBtn = document.getElementById('reset');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const counterEl = document.getElementById('counter');

    let DATA = buildPlayers();
    let page=1, pageSize=+pageSizeSel.value;

    function applyFilters(){
      const term = q.value.trim().toLowerCase();
      let rows = [...DATA];
      if(term) rows = rows.filter(r => r.name.toLowerCase().includes(term));

      switch(sortSel.value){
        case 'points_asc': rows.sort((a,b)=>(a.points||0)-(b.points||0)); break;
        case 'name_asc': rows.sort((a,b)=>a.name.localeCompare(b.name)); break;
        case 'name_desc': rows.sort((a,b)=>b.name.localeCompare(a.name)); break;
        default: rows.sort((a,b)=>(b.points||0)-(a.points||0)); // points_desc
      }

      return rows;
    }

    function render(){
      const rows = applyFilters();
      const total = rows.length;
      const pages = Math.max(1, Math.ceil(total / pageSize));
      page = Math.min(page, pages);

      const start = (page-1)*pageSize;
      const slice = rows.slice(start, start+pageSize);

      tbody.innerHTML = slice.map((r,i)=>{
        const pos = start + i + 1;
        const trClass = r.me ? ' class="me"' : '';
        const acts = r.actions==null ? '‚Äî' : r.actions;
        return `<tr${trClass}>
          <td><b>${pos}</b></td>
          <td>${r.name}${r.me ? ' <span class="badge">T√∫</span>':''}</td>
          <td><b>${r.points||0}</b></td>
          <td>${acts}</td>
          <td>${fmtDate(r.last)}</td>
        </tr>`;
      }).join('');

      prevBtn.disabled = page<=1;
      nextBtn.disabled = page>=pages;
      counterEl.textContent = total ? `Mostrando ${start+1}‚Äì${Math.min(start+pageSize,total)} de ${total}` : 'Sin resultados';
    }

    // === Perfil lateral ===
    const meNameEl = document.getElementById('meName');
    const mePointsEl = document.getElementById('mePoints');
    const meActsEl = document.getElementById('meActs');
    const meStreakEl = document.getElementById('meStreak');
    function renderMe(){
      meNameEl.textContent = state.me.name || '‚Äî';
      mePointsEl.textContent = state.me.points || 0;
      meActsEl.textContent = (state.photos||[]).length;
      meStreakEl.textContent = (calcStreak(state.photos||[])) + ' d√≠as';
    }

    // === Eventos ===
    q.addEventListener('input', ()=>{ page=1; render(); });
    sortSel.addEventListener('change', ()=>{ page=1; render(); });
    pageSizeSel.addEventListener('change', ()=>{ pageSize=+pageSizeSel.value; page=1; render(); });
    resetBtn.addEventListener('click', ()=>{ q.value=''; sortSel.value='points_desc'; pageSizeSel.value='20'; pageSize=20; page=1; render(); });

    prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; render(); } });
    nextBtn.addEventListener('click', ()=>{ page++; render(); });

    document.getElementById('setName').addEventListener('click', ()=>{
      const curr = state.me.name || '';
      const name = prompt('Escribe tu nombre para el ranking:', curr)?.trim();
      if(!name) return;
      state.me.name = name;
      // si no exist√≠a en players, agr√©galo
      const idx = (state.players||[]).findIndex(p=>p.name===name);
      if(idx<0) state.players.push({name, points: state.me.points||0});
      save();
      DATA = buildPlayers();
      renderMe(); page=1; render();
      alert('¬°Nombre guardado! Ahora apareces en el ranking.');
    });

    // === Init ===
    renderMe(); render();
  </script>
</body>
</html>